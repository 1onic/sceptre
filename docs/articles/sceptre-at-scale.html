<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>`sceptre` at scale • sceptre</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="`sceptre` at scale">
<meta property="og:description" content="sceptre">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sceptre</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Function reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/sceptre-at-scale.html">sceptre at scale</a>
    </li>
    <li>
      <a href="../articles/sceptre-small-example.html">sceptre on small data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="sceptre-at-scale_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>
<code>sceptre</code> at scale</h1>
            
      
      
      <div class="hidden name"><code>sceptre-at-scale.Rmd</code></div>

    </div>

    
    
<p>This vignette shows how to run <code>sceptre</code> at scale in a Linux or Unix environment.</p>
<div id="important-note" class="section level1">
<h1 class="hasAnchor">
<a href="#important-note" class="anchor"></a>Important note</h1>
<p><code>sceptre</code> is powered under the hood by <code>ondisc</code>, an R package that enables fast, universal, and intuitive computing on large-scale single-cell data. If you would like to apply at-scale <code>sceptre</code> to your own data, you must (i) convert your gene expression and gRNA perturbation data into <code>ondisc_matrix</code> objects, (ii) produce a list of gene-gRNA pairs to analyze, and (iii) compute the cell-specific matrix of technical factors. Please see the tutorial “<a href="https://timothy-barry.github.io/ondisc/articles/setting_up_a_crispr_screen.html">Setting up a single-cell pooled CRISPR screen</a>,” located on the <code>ondisc</code> <a href="https://timothy-barry.github.io/ondisc/">website</a>, for instructions on how to do this.</p>
<p>If you have completed the above tutorial, you can work through the entirety of this vignette. If not, you can work through sections 1-3 of this vignette, which demonstrate how to run <code>sceptre</code> at scale on a small, example dataset that ships with the package.</p>
</div>
<div id="obtaining-the-scripts" class="section level1">
<h1 class="hasAnchor">
<a href="#obtaining-the-scripts" class="anchor"></a>1. Obtaining the scripts</h1>
<p>First, ensure that you have downloaded and installed <code>sceptre</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"timothy-barry/sceptre"</span><span class="op">)</span></code></pre></div>
<p>Next, open the terminal and navigate to a directory in which you would like to run the analysis. For example:</p>
<pre><code># in terminal
mkdir ~/my_sceptre_dir
cd ~/my_sceptre_dir</code></pre>
<p>Execute the following command to copy the scripts required to run <code>sceptre</code> into the current directory. Be sure to include the period at the end.</p>
<pre><code># in terminal
pkg_dir=$(Rscript -e "cat(find.package('sceptre'))"); cp -r $pkg_dir"/at_scale_scripts" .</code></pre>
<p>This command creates a directory called <code>at_scale_scripts</code> containing a bash script <code>sceptre_at_scale.bash</code> and an R file <code>param_file.R</code>. The bash script <code>sceptre_at_scale.bash</code> contains code to run the analysis, and the R file <code>param_file.R</code> stores the parameters to be used in the analysis.</p>
<pre><code># in terminal
cd at_scale_scripts
ls # view sceptre_at_scale.bash and param_file.R</code></pre>
</div>
<div id="examining-the-parameter-file" class="section level1">
<h1 class="hasAnchor">
<a href="#examining-the-parameter-file" class="anchor"></a>2. Examining the parameter file</h1>
<p>Let’s look at the contents of <code>param_file.R</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#param_file.R</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://timothy-barry.github.io/ondisc/">ondisc</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">sceptre</span><span class="op">)</span>
<span class="va">param_funct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">param</span><span class="op">)</span> <span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span><span class="va">param</span>,
               <span class="co"># modify the parameters below</span>
               storage_dir <span class="op">=</span> <span class="st">"~/my_sceptre_dir/"</span>,
               expression_matrix <span class="op">=</span> <span class="fu"><a href="https://timothy-barry.github.io/ondisc//reference/ondisc_matrix.html">ondisc_matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                                                             <span class="st">"expressions.h5"</span>,
                                                             package <span class="op">=</span> <span class="st">"sceptre"</span><span class="op">)</span><span class="op">)</span>,
               perturbation_matrix <span class="op">=</span> <span class="fu"><a href="https://timothy-barry.github.io/ondisc//reference/ondisc_matrix.html">ondisc_matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                                                               <span class="st">"perturbations.h5"</span>,
                                                               package <span class="op">=</span> <span class="st">"sceptre"</span><span class="op">)</span><span class="op">)</span>,
               covariate_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                                                      <span class="st">"covariate_matrix.rds"</span>,
                                                      package <span class="op">=</span> <span class="st">"sceptre"</span><span class="op">)</span><span class="op">)</span>,
               gene_gRNA_pairs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                                                     <span class="st">"gene_gRNA_pairs.rds"</span>,
                                                     package <span class="op">=</span> <span class="st">"sceptre"</span><span class="op">)</span><span class="op">)</span>,
               side <span class="op">=</span> <span class="st">"left"</span>,
               pod_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>gene <span class="op">=</span> <span class="fl">3</span>, gRNA <span class="op">=</span> <span class="fl">2</span>, pair <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,
               regularization_amount <span class="op">=</span> <span class="fl">1</span>,
               seed <span class="op">=</span> <span class="fl">4</span>,
               B <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This script contains a single function <code>param_funct</code>, which takes the name of a parameter as an argument and returns the value of that parameter. <code>param_funct</code> accepts the following arguments:</p>
<ul>
<li><p><code>storage_dir</code>: the name of a directory in which to store the intermediate computations and final results.</p></li>
<li><p><code>expression_matrix</code>: the gene expression data, represented as an <code>ondisc_matrix</code>.</p></li>
<li><p><code>perturbation_matrix</code>: the gRNA perturbation data, represented as an <code>ondisc_matrix</code>.</p></li>
<li><p><code>covariate_matrix</code>: the matrix of cell-specific covariates, represented as a data frame.</p></li>
<li><p><code>gene_gRNA_pairs</code>: a data frame storing the gene-gRNA pairs to analyze. The data frame must contain columns named <code>gene_id</code> and <code>gRNA_id</code>.</p></li>
<li><p><code>side</code>: the sidedness of the test; “left” performs a left-tailed test, “right” performs a right-tailed test, and “both” performs a two-tailed test. “left” is most appropriate for experiments in which cis-regulatory relationships are tested by perturbing putative enhancers with CRISPRi.</p></li>
<li><p><code>pod_sizes</code>: an integer vector giving the size of the “gene”, “gRNA”, and “pair” pods. <code>sceptre</code> groups the genes, gRNAs, and gene-gRNA pairs into distinct “pods” and runs computations on these pods in parallel. Smaller pod sizes give rise to greater parallelization. <code>pod_sizes</code> is vector of length three with names “gene”, “gRNA”, and “pair” and integer values giving the pod sizes.</p></li>
<li><p><code>regularization_amount</code>: the amount of regularization to apply to the estimated negative binomial size parameters, where 0 corresponds to no regularization at all. A reasonable default choice is 1. Note that <code>regularization_amount</code> affects only the power, not the validity, of the test.</p></li>
<li><p><code>B</code>: number of random samples to draw in the conditional randomization test; a reasonable default choice is 500.</p></li>
<li><p><code>seed</code>: seed to pass to the random number generator; any integer value suffices.</p></li>
</ul>
<p>By default, <code>param_file.R</code> contains example data that ship with <code>sceptre</code>. <code>expression_matrix</code> and <code>perturbation_matrix</code> are small gene expression and gRNA perturbation matrices, respectively, sampled from Gasperini et al. 2019.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">expression_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://timothy-barry.github.io/ondisc//reference/ondisc_matrix.html">ondisc_matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                                 <span class="st">"expressions.h5"</span>,
                                 package <span class="op">=</span> <span class="st">"sceptre"</span><span class="op">)</span><span class="op">)</span>
<span class="va">expression_matrix</span></code></pre></div>
<pre><code>## An ondisc_matrix with 5 features and 205797 cells.</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">perturbation_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://timothy-barry.github.io/ondisc//reference/ondisc_matrix.html">ondisc_matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                                   <span class="st">"perturbations.h5"</span>,
                                   package <span class="op">=</span> <span class="st">"sceptre"</span><span class="op">)</span><span class="op">)</span>
<span class="va">perturbation_matrix</span></code></pre></div>
<pre><code>## An ondisc_matrix with 4 features and 205797 cells.</code></pre>
<p><code>covariate_matrix</code> stores the cell-specific technical factors for <code>expression_matrix</code> and <code>perturbation_matrix</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">covariate_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                                <span class="st">"covariate_matrix.rds"</span>,
                                package <span class="op">=</span> <span class="st">"sceptre"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">covariate_matrix</span><span class="op">)</span></code></pre></div>
<pre><code>##        p_mito   prep_batch lg_total_umis lg_guide_count lg_n_genes
## 1 0.058786706 prep_batch_1      9.774062       4.204693   8.174421
## 2 0.036086518 prep_batch_1      9.096387       3.258097   7.841100
## 3 0.069823051 prep_batch_1      9.591308       4.110874   8.068090
## 4 0.026186508 prep_batch_1     10.034428       3.663562   8.420462
## 5 0.007991318 prep_batch_1      9.223849       3.610918   7.865188
## 6 0.022356681 prep_batch_1      9.185125       4.043051   7.690286</code></pre>
<p>Finally, <code>gene_gRNA_pairs</code> contains a list of gene-gRNA pairs for which we seek <em>p</em>-values.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gene_gRNA_pairs</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                               <span class="st">"gene_gRNA_pairs.rds"</span>,
                               package <span class="op">=</span> <span class="st">"sceptre"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">gene_gRNA_pairs</span><span class="op">)</span></code></pre></div>
<pre><code>##           gene_id            gRNA_id
## 1 ENSG00000237683 chr11.2465_top_two
## 2 ENSG00000228463 chr11.2465_top_two
## 3 ENSG00000235373 chr11.2465_top_two
## 4 ENSG00000225880 chr11.2465_top_two
## 5 ENSG00000188976 chr11.2465_top_two
## 6 ENSG00000237683 chr10.1153_top_two</code></pre>
</div>
<div id="running-sceptre-on-the-example-data" class="section level1">
<h1 class="hasAnchor">
<a href="#running-sceptre-on-the-example-data" class="anchor"></a>3. Running <code>sceptre</code> on the example data</h1>
<p>To run <code>sceptre</code> on the set of parameters defined in <code>param_file.R</code>, simply call <code>bash</code> on the file <code>sceptre_at_scale.bash</code> within the directory <code>at_scale_scripts</code>.</p>
<pre><code># in terminal
bash sceptre_at_scale.bash</code></pre>
<p>Alternately, make the file <code>sceptre_at_scale.bash</code> executable and execute it directly.</p>
<pre><code># in terminal
chmod 700 sceptre_at_scale.bash
./sceptre_at_scale.bash</code></pre>
<p>Executing this script results in the creation of several new subdirectories in the <code>storage_dir</code> directory: <code>gene_precomp</code>, <code>gRNA_precomp</code>, <code>logs</code>, and <code>results</code>. <code>gene_precomp</code> and <code>gRNA_precomp</code> store the results of the intermediate computations; <code>logs</code> stores the log files that allow us to monitor the progress of the program; and <code>results</code> stores the results, including the final result file <code>all_results.rds</code>.</p>
<p>We can view the <code>logs</code> files during program execution by opening a new terminal and navigating to the appropriate directory.</p>
<pre><code># in new terminal window
cd ~/my_sceptre_dir/logs
# view gene_precomp_round_1_pod_1.Rout, for example
cat gene_precomp_round_1_pod_1.Rout</code></pre>
<p>When the program has finished running, we can load the final results into R for downstream analysis.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">storage_dir</span>, <span class="st">"/results/all_results.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="running-sceptre-on-other-datasets" class="section level1">
<h1 class="hasAnchor">
<a href="#running-sceptre-on-other-datasets" class="anchor"></a>4. Running <code>sceptre</code> on other datasets</h1>
<p>We can apply <code>sceptre</code> to arbitrary single-cell CRISPR screen datasets. For example, we can apply <code>sceptre</code> to the Gasperini et al. 2019 data that we preprocessed in the tutorial “<a href="https://timothy-barry.github.io/ondisc/articles/setting_up_a_crispr_screen.html">Setting up a single-cell pooled CRISPR screen</a>.” Recall that we created several files in that tutorial, all of which we saved to the “processed data” directory:</p>
<ol style="list-style-type: decimal">
<li>The expressions.rds <code>ondisc_matrix</code>, plus its backing .h5 file,</li>
<li>The perturbations.rds <code>ondisc_matsrix</code>, plus its backing .h5 file,</li>
<li>The cell_covariate_matrix.rds file, and</li>
<li>The gene_gRNA_pairs.rds file.</li>
</ol>
<p>To run <code>sceptre</code> on these data, we must create an new parameter file. We begin by copying the contents of <code>param_file.R</code> into a new file <code>param_file_big.R</code>.</p>
<pre><code># in terminal
cd ~/my_sceptre_dir/at_scale_scripts
cp param_file.R param_file_big.R</code></pre>
<p>Next, we open the file <code>param_file_big.R</code> and update the fields withinin the <code>switch</code> statement. Be sure to change the file path of <code>example_dir</code> so that it matches the <code>example_dir</code> you defined in “Setting up a single-cell pooled CRISPR screen.” (See the first code block in Section 1 of that tutorial.)</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># param_file_big.R</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://timothy-barry.github.io/ondisc/">ondisc</a></span><span class="op">)</span>
<span class="va">example_dir</span> <span class="op">&lt;-</span> <span class="st">"/Volumes/tims_new_drive/research/sceptre_example"</span> <span class="co"># change me!</span>

<span class="va">processed_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">example_dir</span>, <span class="st">"/processed_data"</span><span class="op">)</span>
<span class="va">param_funct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">param</span><span class="op">)</span> <span class="op">{</span>
        <span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span><span class="va">param</span>,
               <span class="co"># modify the parameters below</span>
               storage_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">example_dir</span>, <span class="st">"/storage_dir"</span><span class="op">)</span>,
               expression_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">processed_dir</span>, <span class="st">"/expressions.rds"</span><span class="op">)</span><span class="op">)</span>,
               perturbation_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">processed_dir</span>, <span class="st">"/perturbations.rds"</span><span class="op">)</span><span class="op">)</span>,
               covariate_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">processed_dir</span>, <span class="st">"/cell_covariate_matrix.rds"</span><span class="op">)</span><span class="op">)</span>,
               gene_gRNA_pairs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">processed_dir</span>, <span class="st">"/gene_gRNA_pairs.rds"</span><span class="op">)</span><span class="op">)</span>,
               side <span class="op">=</span> <span class="st">"left"</span>,
               pod_sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>gene <span class="op">=</span> <span class="fl">100</span>, gRNA <span class="op">=</span> <span class="fl">5</span>, pair <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,
               regularization_amount <span class="op">=</span> <span class="fl">1</span>,
               seed <span class="op">=</span> <span class="fl">4</span>,
               B <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Notice that we have changed the location of <code>storage_dir</code> to a subdirectory in <code>example_dir</code>. For large-scale analyses, it is often convenient put the “storage directory” nearby the data, which in this case are located in <code>example_dir</code>.</p>
<p>We run <code>sceptre</code> on the parameters defined in this file by calling <code>bash</code> on <code>sceptre_at_scale.bash</code>, passing <code>param_file_big.R</code> as a command line argument.</p>
<pre><code># in terminal
bash sceptre_at_scale.bash param_file_big.R</code></pre>
<p>This program takes about 15 minutes to run on a Macbook Pro. There might be several warnings produced by “vglm.fitter” about convergence. These warnings are related to the gene expression regressions and are safe to ignore, as the validity of <code>sceptre</code> does not depend on an accurate model for gene expression. There additionally might be several warnings produced by “st.infoUv” about “score not quite 0.” These warnings are related to the skew-t fit of the resampled test statistics and likewise are safe to ignore, as the score (i.e., gradient of the log-likelihood) does not need to be exactly 0 for the <em>p</em>-value to be accurate.</p>
<p>The results of the analysis are stored in example_dir/storage_dir/results.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results_fp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">example_dir</span>, <span class="st">"/storage_dir/results/all_results.rds"</span><span class="op">)</span>
<span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">results_fp</span><span class="op">)</span></code></pre></div>
<p>And with that, we have completed our analysis!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://timothy-barry.github.io/">Timothy Barry</a>, Eugene Katsevich.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
